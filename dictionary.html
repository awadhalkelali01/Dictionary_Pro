<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ูุงููุณ ุงูุทุงูุจ | ุงููุงููุณ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="style.css" />

<link rel="manifest" href="manifest.json">

<script>
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
            .catch(err => console.log("SW registration failed:", err));
    });
}
</script>

</head>
<body>
<div class="app-shell">

    <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
    <header class="app-header">
        <div class="container header-content">
            <div class="brand">
                <div class="brand-mark">
                    <span>A+</span>
                </div>
                <div class="brand-text">
                    <span class="brand-title">ูุงููุณ ุงูุทุงูุจ</span>
                    <span class="brand-subtitle-en">Student Dictionary</span>
                </div>
            </div>

            <!-- ุฒุฑ ุงููุงุฆูุฉ ููุฌูุงู -->
            <button class="nav-toggle" type="button" aria-label="ูุชุญ/ุฅุบูุงู ุงููุงุฆูุฉ" aria-expanded="false">
                <span class="nav-toggle-bar"></span>
                <span class="nav-toggle-bar"></span>
                <span class="nav-toggle-bar"></span>
            </button>

            <!-- ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ -->
            <nav class="main-nav" aria-label="ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ">
                <a href="index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a>
                <a href="students.html" class="nav-link">ุงูุทูุงุจ</a>
                <a href="dictionary.html" class="nav-link active">ุงููุงููุณ</a>
                <a href="quiz.html" class="nav-link">ุงูุงุฎุชุจุงุฑุงุช</a>
                <a href="about.html" class="nav-link">ุนู ุงููุงููุณ</a>
                <a href="help.html" class="nav-link">ูุณุงุนุฏุฉ</a>
            </nav>
        </div>
    </header>

    <!-- ุงููุญุชูู -->
    <main class="app-main">
        <div class="container">

            <!-- ุนููุงู ุงูุตูุญุฉ + ูุนูููุงุช ุงูุทุงูุจ -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">ุงููุงููุณ ุงูุชูุงุนูู</h1>
                    <div id="student-header" style="margin-top:0.4rem;display:flex;align-items:center;gap:0.75rem;min-height:52px;">
                        <div id="student-avatar-wrap" style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;display:none;">
                            <img id="student-avatar" src="" alt="ุตูุฑุฉ ุงูุทุงูุจ" style="width:48px;height:48px;object-fit:cover;border-radius:50%;" />
                        </div>
                        <div style="display:flex;flex-direction:column;gap:0.1rem;">
                            <span id="student-name-line" style="font-size:1.05rem;font-weight:600;color:#e5e7eb;">
                                ูู ูุชู ุงุฎุชูุงุฑ ุทุงูุจ ุจุนุฏ
                            </span>
                            <span id="student-grade-line" style="font-size:0.85rem;color:#9ca3af;">
                                ุงุฎุชุฑ ุงูุทุงูุจ ูู ุงููุงุฆูุฉ ุฃุฏูุงู ูุนุฑุถ ูุงููุณู ุงูุฎุงุต.
                            </span>
                        </div>
                    </div>
                </div>

                <div class="page-header-meta">
                    <span class="tag">ุนุฏุฏ ุงููููุงุช: <span id="dict-count">0</span></span>
                    <span class="tag tag-soft">ูุงููุณ ููุฒูู ููู ุทุงูุจ ุนูู ุญุฏุฉ</span>
                </div>
            </header>

            <!-- ุฃุฏูุงุช ุงููุงููุณ (ุงูุทุงูุจ + ุงูุชุตููู + ุงูุจุญุซ) -->
            <section class="page-toolbar">
                <div class="toolbar-group">
                    <label class="toolbar-label" for="student-select">ุงูุทุงูุจ</label>
                    <select id="student-select" class="form-control">
                        <option value="">ุงุฎุชุฑ ุงูุทุงูุจ...</option>
                    </select>
                </div>

                <div class="toolbar-group">
                    <label class="toolbar-label" for="category-filter">ุงูุชุตููู</label>
                    <select id="category-filter" class="form-control">
                        <option value="">ูู ุงูุชุตูููุงุช</option>
                        <option value="noun">ุงุณู (Noun)</option>
                        <option value="verb">ูุนู (Verb)</option>
                        <option value="adj">ุตูุฉ (Adjective)</option>
                        <option value="adv">ุธุฑู (Adverb)</option>
                    </select>
                </div>

                <div class="toolbar-group">
                    <label class="toolbar-label" for="word-search">ุจุญุซ</label>
                    <input
                        id="word-search"
                        type="search"
                        class="form-control"
                        placeholder="ุงูุชุจ ุงููููุฉ ุจุงูุนุฑุจูุฉ ุฃู ุงูุฅูุฌููุฒูุฉ..."
                    />
                </div>
            </section>

            <!-- ุนููุฏุงู: ุงููููุฐุฌ + ุงููุงุฆูุฉ -->
            <section class="page-layout-2col">

                <!-- ูููุฐุฌ ุฅุถุงูุฉ ูููุฉ -->
                <article class="card">
                    <h2 class="card-title">ุฅุถุงูุฉ ูููุฉ ุฌุฏูุฏุฉ</h2>
                    <p class="card-description">
                        ุงุฎุชุฑ ุงูุทุงูุจ ุฃููุงูุ ุซู ุฃุฏุฎู ุงููููุฉ ููุนูุงูุง ูุฌููุฉ ูุซุงู. ูุชู ุถุจุท ุงููุงุจูุชุงู ูุงูููุทุฉ ุชููุงุฆููุง.
                    </p>

                    <form id="word-form" class="form-grid">
                        <div class="form-field">
                            <label class="form-label" for="word-arabic">ุงููููุฉ (ุงูุนุฑุจูุฉ) *</label>
                            <input
                                type="text"
                                id="word-arabic"
                                class="form-control"
                                required
                                placeholder="ูุซุงู: ูุฏุฑุณุฉ"
                                data-error-target="error-word-arabic"
                            />
                            <div class="field-error" id="error-word-arabic"></div>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="word-english">ุงููููุฉ (ุงูุฅูุฌููุฒูุฉ) *</label>
                            <input
                                type="text"
                                id="word-english"
                                class="form-control"
                                required
                                placeholder="ูุซุงู: School"
                                data-error-target="error-word-english"
                            />
                            <div class="field-error" id="error-word-english"></div>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="word-category">ุงูุชุตููู *</label>
                            <select id="word-category" class="form-control" required>
                                <option value="">ุงุฎุชุฑ ุงูุชุตููู...</option>
                                <option value="noun">ุงุณู (Noun)</option>
                                <option value="verb">ูุนู (Verb)</option>
                                <option value="adj">ุตูุฉ (Adjective)</option>
                                <option value="adv">ุธุฑู (Adverb)</option>
                            </select>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="word-example-en">ุงูุฌููุฉ (ุฅูุฌููุฒู)</label>
                            <input
                                type="text"
                                id="word-example-en"
                                class="form-control"
                                placeholder="ูุซุงู: I go to school every day"
                                data-error-target="error-word-example-en"
                            />
                            <div class="field-error" id="error-word-example-en"></div>
                        </div>

                        <div class="form-field">
                            <label class="form-label" for="word-example-ar">ุชุฑุฌูุฉ ุงูุฌููุฉ (ุนุฑุจู)</label>
                            <input
                                type="text"
                                id="word-example-ar"
                                class="form-control"
                                placeholder="ูุซุงู: ุฃุฐูุจ ุฅูู ุงููุฏุฑุณุฉ ูู ููู"
                                data-error-target="error-word-example-ar"
                            />
                            <div class="field-error" id="error-word-example-ar"></div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">ุญูุธ ุงููููุฉ</button>
                            <button type="reset" class="btn btn-outline">ูุณุญ</button>
                        </div>

        <p class="form-hint" id="dict-form-hint">
            ุงุฎุชุฑ ุงูุทุงูุจ ุฃููุงู ูู ุฃุนูู ุงูุตูุญุฉ. ูุชู ุญูุธ ุงููููุงุช ุชููุงุฆููุง ููู ุทุงูุจ ุนูู ูุฐุง ุงูุฌูุงุฒ ูุน ุฅููุงููุฉ ุงูุชุตุฏูุฑ ูุงูุงุณุชูุฑุงุฏ.
        </p>
    </form>

    <!-- ุจุทุงูุฉ ุฅุญุตุงุกุงุช ุงููุงููุณ -->
    <section id="dict-stats" class="dict-stats-card">
        <h3 class="dict-stats-title">ุฅุญุตุงุกุงุช ุงููุงููุณ</h3>
        <p class="dict-stats-subtitle">
            ุชูุฒูุน ุงููููุงุช ุญุณุจ ุงูููุน ููุทุงูุจ ุงููุฎุชุงุฑ.
        </p>

        <div class="dict-stats-grid">
            <!-- ุฅุฌูุงูู ุงููููุงุช -->
            <div class="stat-box">
                <div class="stat-label">ุฅุฌูุงูู ุงููููุงุช</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>

            <!-- ุงูุฃุณูุงุก -->
            <div class="stat-box">
                <div class="stat-label">ุงูุฃุณูุงุก (Noun)</div>
                <div class="stat-value-row">
                    <span class="stat-value" id="stat-noun">0</span>
                    <span class="stat-percent" id="stat-noun-perc">0%</span>
                </div>
            </div>

            <!-- ุงูุฃูุนุงู -->
            <div class="stat-box">
                <div class="stat-label">ุงูุฃูุนุงู (Verb)</div>
                <div class="stat-value-row">
                    <span class="stat-value" id="stat-verb">0</span>
                    <span class="stat-percent" id="stat-verb-perc">0%</span>
                </div>
            </div>

            <!-- ุงูุตูุงุช -->
            <div class="stat-box">
                <div class="stat-label">ุงูุตูุงุช (Adj)</div>
                <div class="stat-value-row">
                    <span class="stat-value" id="stat-adj">0</span>
                    <span class="stat-percent" id="stat-adj-perc">0%</span>
                </div>
            </div>

            <!-- ุงูุธุฑูู -->
            <div class="stat-box">
                <div class="stat-label">ุงูุธุฑูู (Adv)</div>
                <div class="stat-value-row">
                    <span class="stat-value" id="stat-adv">0</span>
                    <span class="stat-percent" id="stat-adv-perc">0%</span>
                </div>
            </div>
	   <!-- ุฃุญุฏุซ ูููุฉ -->
	       <div class="stat-box">
     	       <div class="stat-label">ุฃุญุฏุซ ุฅุถุงูุฉ</div>
   	       <div class="stat-latest" id="stat-latest">
	        ูุง ุชูุฌุฏ ูููุงุช ุจุนุฏ
	       </div>
	   </div>
        </div>
    </section>
</article>


                <!-- ูุงุฆูุฉ ุงููููุงุช + ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช -->
                <article class="card">
                    <div class="table-header">
                        <div>
                            <h2 class="card-title">ูุงุฆูุฉ ุงููููุงุช</h2>
                            <p class="card-description">
                                ุงููููุงุช ุงูุฎุงุตุฉ ุจุงูุทุงูุจ ุงููุฎุชุงุฑ ููุท. ููููู ูุชุญ ุจุทุงูุฉ ุงูุชูุงุตูู ูููุทู ูุงูุชุนุฏูู ูุงูุงุทูุงุน ุนูู ุงูุฃูุซูุฉ.
                            </p>
                        </div>
                    </div>

			<div class="table-wrapper dict-table-wrapper dict-scroll">

  			  <table class="data-table" aria-label="ูุงุฆูุฉ ุงููููุงุช">
<thead>
<tr>
    <th class="sortable" data-key="ar">ุงูุนุฑุจูุฉ</th>
    <th class="sortable" data-key="en">ุงูุฅูุฌููุฒูุฉ</th>
    <th class="sortable" data-key="cat">ุงูุชุตููู</th>
    <th class="sortable" data-key="senEn">ูุซุงู (ุฅูุฌููุฒู)</th>
    <th style="text-align:center;">
    <button id="reset-sort-btn" class="reset-sort-btn" title="ุฅุนุงุฏุฉ ุงูุชุฑุชูุจ ุงูุงูุชุฑุงุถู">โฒ</button>
</th>
</tr>
</thead>

                            <tbody id="dict-body">
                            <!-- ูุชู ููุคูุง ูู ุงูุชุฎุฒูู ุญุณุจ ุงูุทุงูุจ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ุงูุชุฑููู -->
                    <div class="table-pagination" id="dict-pagination"></div>

                    <!-- ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช (ุชุตุฏูุฑ / ุงุณุชูุฑุงุฏ / ุญุฐู ุงููู) -->
                    <section class="data-tools" aria-label="ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงููุงููุณ">
                        <h3 class="data-tools-title">ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงููุงููุณ ููุทุงูุจ ุงูุญุงูู</h3>
                        <p class="data-tools-text">
                            ููููู ุญูุธ ูููุงุช ุงูุทุงูุจ ูููู JSON ุฃู XMLุ ุฃู ุงุณุชูุฑุงุฏ ููู ูููุงุช ุฌุงูุฒ. ุชุชู ุงูุฅุถุงูุฉ ููุท ูููููุงุช ุงูุฌุฏูุฏุฉ.
                        </p>
                        <div class="data-tools-actions">
                            <button type="button" class="btn btn-outline data-btn" id="export-json-btn">
                                ุชุตุฏูุฑ ุงููุงููุณ JSON
                            </button>
                            <button type="button" class="btn btn-outline data-btn" id="export-xml-btn">
                                ุชุตุฏูุฑ ุงููุงููุณ XML
                            </button>
                            <label class="btn btn-primary data-btn">
                                ุงุณุชูุฑุงุฏ JSON / XML
                                <input
                                    type="file"
                                    id="import-file"
                                    accept=".json,.xml"
                                    style="display: none;"
                                />
                            </label>
                        </div>
                        <div style="margin-top:0.75rem;">
                            <button
                                type="button"
                                class="btn btn-outline data-btn"
                                id="clear-all-btn"
                                style="border-color:#b91c1c;color:#fecaca;"
                            >
                                ๐ ุญุฐู ุฌููุน ูููุงุช ุงูุทุงูุจ
                            </button>
                        </div>
                        <p class="data-tools-result" id="import-result"></p>
                    </section>

                    <p class="table-hint">
                        ุนูุฏ ุงูุงุณุชูุฑุงุฏุ ูุชู ุชุฌุงูู ุงููููุงุช ุงูููุฌูุฏุฉ ูุณุจููุง (ุญุณุจ ุงููููุฉ ุงูุฅูุฌููุฒูุฉ) ูุฅุถุงูุฉ ุงููููุงุช ุงูุฌุฏูุฏุฉ ููุท.
                    </p>
                </article>
            </section>
        </div>
    </main>

    <!-- ุงูููุชุฑ -->
    <footer class="app-footer">
        <div class="container footer-content">
            <div class="footer-main">
                <span class="footer-title">ูุงููุณ ุงูุทุงูุจ</span>
                <span class="footer-subtitle">ูุงููุณ ููุฒูู ุจุณูุท ููู ุทุงูุจ ูุน ูุทู ููุณุฎ ุงุญุชูุงุทู.</span>
            </div>
            <div class="footer-links">
                <a href="about.html">ุนู ุงููุงููุณ</a>
                <a href="help.html">ูุณุงุนุฏุฉ</a>
            </div>
        </div>
    </footer>
</div>

<!-- ุงูููุฏุงู (ุจุทุงูุฉ ุงููููุฉ) -->
<div class="word-modal-backdrop" id="word-modal" aria-hidden="true">
    <div class="word-modal" role="dialog" aria-modal="true" aria-labelledby="modal-word-en">


        <div class="word-modal-header">
            <div class="word-main">
                <div class="word-en-row">
                    <span class="word-en-text" id="modal-word-en" dir="ltr">School</span>
                    <input
                        type="text"
                        class="form-control modal-input"
                        id="modal-word-en-input"
                        dir="ltr"
                        data-error-target="error-modal-word-en"
                    />
                    <button
                        type="button"
                        class="icon-btn"
                        id="speak-word-btn"
                        aria-label="ูุทู ุงููููุฉ ุจุงูุฅูุฌููุฒูุฉ"
                    >
                        ๐
                    </button>
                </div>
                <div class="field-error" id="error-modal-word-en"></div>

                <div class="word-ar-wrap">
                    <span class="word-ar-text" id="modal-word-ar">ูุฏุฑุณุฉ</span>
                    <input
                        type="text"
                        class="form-control modal-input"
                        id="modal-word-ar-input"
                        data-error-target="error-modal-word-ar"
                    />
                </div>
                <div class="field-error" id="error-modal-word-ar"></div>

                <div class="word-cat-wrap">
                    <span class="word-cat-text" id="modal-word-cat">ุงุณู (Noun)</span>
                    <select id="modal-word-cat-input" class="form-control modal-input">
                        <option value="noun">ุงุณู (Noun)</option>
                        <option value="verb">ูุนู (Verb)</option>
                        <option value="adj">ุตูุฉ (Adjective)</option>
                        <option value="adv">ุธุฑู (Adverb)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="word-modal-body">
            <div class="word-block">
                <div class="word-block-label">ุงูุฌููุฉ ุงูุฅูุฌููุฒูุฉ</div>
                <div class="word-block-line">
                    <p id="modal-sentence-en" dir="ltr">I go to school every day.</p>
                    <input
                        type="text"
                        class="form-control modal-input"
                        id="modal-sentence-en-input"
                        dir="ltr"
                        data-error-target="error-modal-sentence-en"
                    />
                    <button
                        type="button"
                        class="icon-btn"
                        id="speak-sentence-btn"
                        aria-label="ูุทู ุงูุฌููุฉ ุจุงูุฅูุฌููุฒูุฉ"
                    >
                        ๐
                    </button>
                </div>
                <div class="field-error" id="error-modal-sentence-en"></div>
            </div>

            <div class="word-block">
                <div class="word-block-label">ุงูุชุฑุฌูุฉ ุงูุนุฑุจูุฉ ููุฌููุฉ</div>
                <p id="modal-sentence-ar">ุฃุฐูุจ ุฅูู ุงููุฏุฑุณุฉ ูู ููู.</p>
                <input
                    type="text"
                    class="form-control modal-input"
                    id="modal-sentence-ar-input"
                    data-error-target="error-modal-sentence-ar"
                />
                <div class="field-error" id="error-modal-sentence-ar"></div>
            </div>

            <!-- ุฅุนุฏุงุฏุงุช ุงูุตูุช -->
            <div class="audio-card">
                <div class="audio-card-title">ุฅุนุฏุงุฏุงุช ุงูุตูุช</div>
                <div class="audio-card-row">
                    <label class="audio-label" for="voice-select">ุงูููุฌุฉ (ุงูุตูุช):</label>
                    <select id="voice-select" class="form-control audio-select">
                        <option value="">ุงุฎุชูุงุฑ ุชููุงุฆู (ุฃูุถู ุตูุช ุฅูุฌููุฒู)</option>
                    </select>
                </div>
                <div class="audio-card-row">
                    <span class="audio-label">ุณุฑุนุฉ ุงููุทู:</span>
                    <div class="audio-rate-control">
                        <button type="button" class="audio-rate-btn" id="rate-down">-</button>
                        <span class="audio-rate-value" id="rate-value">0.95</span>
                        <button type="button" class="audio-rate-btn" id="rate-up">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="word-modal-actions">
            <!-- ูุถุน ุงูุนุฑุถ -->
            <div id="modal-view-actions" style="display:flex;gap:0.5rem;justify-content:flex-end;flex-wrap:wrap;">
                <button type="button" class="btn btn-outline" id="modal-edit-btn">ุชุนุฏูู</button>
                <button
                    type="button"
                    class="btn btn-outline"
                    id="modal-delete-btn"
                    style="border-color:#b91c1c;color:#fecaca;"
                >
                    ๐ ุญุฐู ุงููููุฉ
                </button>
                <button type="button" class="btn btn-outline" id="modal-close-btn2">ุฅุบูุงู</button>
            </div>

            <!-- ูุถุน ุงูุชุนุฏูู -->
            <div class="word-modal-edit-actions" id="modal-edit-actions" style="display:none;gap:0.5rem;justify-content:flex-end;flex-wrap:wrap;">
                <button type="button" class="btn btn-primary" id="modal-save-btn">ุญูุธ ุงูุชุนุฏูู</button>
                <button type="button" class="btn btn-outline" id="modal-cancel-btn">ุฅูุบุงุก ุงูุชุนุฏูู</button>
            </div>
        </div>
    </div>
</div>

<!-- ููุฏุงู ุชุฃููุฏ ุนุงู ููุญุฐู -->
<div
    id="confirm-backdrop"
    aria-hidden="true"
    style="
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.45);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:1800;
    "
>
    <div
        style="
            background:#111827;
            border-radius:1rem;
            padding:1.5rem;
            max-width:360px;
            width:90%;
            box-shadow:0 25px 50px rgba(0,0,0,0.7);
            border:1px solid #374151;
        "
    >
        <h2 style="margin:0 0 0.75rem;font-size:1rem;color:#f9fafb;">ุชุฃููุฏ ุงูุญุฐู</h2>
        <p
            id="confirm-message"
            style="margin:0 0 1.25rem;font-size:0.9rem;color:#d1d5db;line-height:1.6;"
        >
            ุณูุชู ุญุฐู ูุฐู ุงููููุฉ ูู ูุงููุณ ุงูุทุงูุจ. ูู ุชุฑุบุจ ุจุงููุชุงุจุนุฉุ
        </p>
        <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
            <button type="button" class="btn btn-outline" id="confirm-no">ุฅูุบุงุก</button>
            <button
                type="button"
                class="btn btn-primary"
                id="confirm-yes"
                style="background:#b91c1c;border-color:#b91c1c;"
            >
                ูุนูุ ุงุญุฐู
            </button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div
    id="toast-container"
    style="
        position:fixed;
        bottom:1rem;
        right:1rem;
        z-index:2000;
        display:flex;
        flex-direction:column;
        gap:0.5rem;
        pointer-events:none;
    "
></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ููุงุชูุญ ุงูุชุฎุฒูู
    const STORAGE_KEY_STUDENTS   = "student";
    const DICT_KEY_PREFIX        = "studentDictionary_";
    const STORAGE_KEY_VOICE      = "studentDictionaryVoice_v1";
    const STORAGE_KEY_RATE       = "studentDictionaryRate_v1";
    const TEST_KEY_PREFIX        = "studentTests_";
    const PAGE_SIZE              = 20;

    // ูุงุฆูุฉ ุงูุฌูุงู
    const navToggle = document.querySelector(".nav-toggle");
    const mainNav   = document.querySelector(".main-nav");
    if (navToggle && mainNav) {
        navToggle.addEventListener("click", function () {
            const isOpen = mainNav.classList.toggle("nav-open");
            navToggle.classList.toggle("nav-open", isOpen);
            navToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
        });
    }

    // ุนูุงุตุฑ ุงูุตูุญุฉ
    const studentSelect      = document.getElementById("student-select");
    const studentNameLine    = document.getElementById("student-name-line");
    const studentGradeLine   = document.getElementById("student-grade-line");
    const studentAvatarWrap  = document.getElementById("student-avatar-wrap");
    const studentAvatarImg   = document.getElementById("student-avatar");

    const dictFormHint       = document.getElementById("dict-form-hint");

    const form               = document.getElementById("word-form");
    const tbody              = document.getElementById("dict-body");
    const count              = document.getElementById("dict-count");
    const searchInput        = document.getElementById("word-search");
    const categoryFilter     = document.getElementById("category-filter");
    const paginationContainer= document.getElementById("dict-pagination");
    const dictTableWrapper  = document.querySelector(".dict-table-wrapper");

    // ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช
    const exportJsonBtn      = document.getElementById("export-json-btn");
    const exportXmlBtn       = document.getElementById("export-xml-btn");
    const importFileInput    = document.getElementById("import-file");
    const importResult       = document.getElementById("import-result");
    const clearAllBtn        = document.getElementById("clear-all-btn");

    // ุงูููุฏุงู
    const modalBackdrop      = document.getElementById("word-modal");
    const wordModal          = document.querySelector(".word-modal");
    const modalCloseBtn      = document.getElementById("word-modal-close");

    const modalWordEn        = document.getElementById("modal-word-en");
    const modalWordEnInput   = document.getElementById("modal-word-en-input");
    const modalWordAr        = document.getElementById("modal-word-ar");
    const modalWordArInput   = document.getElementById("modal-word-ar-input");
    const modalWordCat       = document.getElementById("modal-word-cat");
    const modalWordCatInput  = document.getElementById("modal-word-cat-input");
    const modalSentenceEn    = document.getElementById("modal-sentence-en");
    const modalSentenceEnInput = document.getElementById("modal-sentence-en-input");
    const modalSentenceAr    = document.getElementById("modal-sentence-ar");
    const modalSentenceArInput = document.getElementById("modal-sentence-ar-input");

    const speakWordBtn       = document.getElementById("speak-word-btn");
    const speakSentenceBtn   = document.getElementById("speak-sentence-btn");

    const modalViewActions   = document.getElementById("modal-view-actions");
    const modalEditActions   = document.getElementById("modal-edit-actions");
    const modalEditBtn       = document.getElementById("modal-edit-btn");
    const modalSaveBtn       = document.getElementById("modal-save-btn");
    const modalCancelBtn     = document.getElementById("modal-cancel-btn");
    const modalDeleteBtn     = document.getElementById("modal-delete-btn");
    const modalCloseBtn2     = document.getElementById("modal-close-btn2");

    // ุฅุนุฏุงุฏุงุช ุงูุตูุช
    const voiceSelect        = document.getElementById("voice-select");
    const rateDownBtn        = document.getElementById("rate-down");
    const rateUpBtn          = document.getElementById("rate-up");
    const rateValueSpan      = document.getElementById("rate-value");

    // ุญููู ุงููููุฐุฌ ุงูุฃุณุงุณู
    const arInput            = document.getElementById("word-arabic");
    const enInput            = document.getElementById("word-english");
    const catSelect          = document.getElementById("word-category");
    const exEnInput          = document.getElementById("word-example-en");
    const exArInput          = document.getElementById("word-example-ar");

    // Toast & Confirm
    const toastContainer     = document.getElementById("toast-container");
    const confirmBackdrop    = document.getElementById("confirm-backdrop");
    const confirmMessageEl   = document.getElementById("confirm-message");
    const confirmYesBtn      = document.getElementById("confirm-yes");
    const confirmNoBtn       = document.getElementById("confirm-no");
    let confirmHandler       = null;

    // ูุชุบูุฑุงุช ุนุงูุฉ
    let students             = [];
    let currentStudent       = null; // {id, name, grade, avatar}
    let allRows              = [];
    let currentPage          = 1;
    let totalPages           = 1;
    let currentRow           = null;
    let currentWordEn        = "";
    let currentSentenceEn    = "";

    // ุฃุตูุงุช ุงููุทู
    let voices               = [];
    let selectedVoiceName    = "";
    let speechRate           = 0.95;

    // ===== ุฏูุงู ูุณุงุนุฏุฉ ุนุงูุฉ =====
    function setError(input, message) {
        if (!input) return;
        const errorId = input.dataset.errorTarget;
        const errorEl = errorId ? document.getElementById(errorId) : null;
        if (errorEl) errorEl.textContent = message || "";
        if (message) {
            input.classList.add("input-error");
        } else {
            input.classList.remove("input-error");
        }
    }

    function clearErrors(inputs) {
        if (!inputs) return;
        inputs.forEach(i => setError(i, ""));
    }

    function validateEnglish(input, options) {
        if (!input) return true;
        const value = (input.value || "").trim();
        const required = options && options.required;

        if (required && !value) {
            setError(input, "ูุฐุง ุงูุญูู ูุทููุจ (ุฅูุฌููุฒู).");
            return false;
        }
        if (!value) {
            setError(input, "");
            return true;
        }

        const hasArabic = /[\u0600-\u06FF]/.test(value);
        if (hasArabic) {
            setError(input, "ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุญุฑูู ุฅูุฌููุฒูุฉ ููุท ูู ูุฐุง ุงูุญูู.");
            return false;
        }

        const hasLatin = /[A-Za-z]/.test(value);
        if (!hasLatin) {
            setError(input, "ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุต ุฅูุฌููุฒู ุตุญูุญ.");
            return false;
        }

        setError(input, "");
        return true;
    }

    function validateArabic(input, options) {
        if (!input) return true;
        const value = (input.value || "").trim();
        const required = options && options.required;

        if (required && !value) {
            setError(input, "ูุฐุง ุงูุญูู ูุทููุจ (ุนุฑุจู).");
            return false;
        }
        if (!value) {
            setError(input, "");
            return true;
        }

        const hasLatin = /[A-Za-z]/.test(value);
        if (hasLatin) {
            setError(input, "ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุญุฑูู ุนุฑุจูุฉ ููุท ูู ูุฐุง ุงูุญูู.");
            return false;
        }

        const hasArabic = /[\u0600-\u06FF]/.test(value);
        if (!hasArabic) {
            setError(input, "ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุต ุนุฑุจู ุตุญูุญ.");
            return false;
        }

        setError(input, "");
        return true;
    }

    function normalizeEnglishWord(text) {
        const t = text.trim();
        if (!t) return "";
        return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
    }

    function normalizeEnglishSentence(text) {
        let t = text.trim();
        if (!t) return "";
        t = t.charAt(0).toUpperCase() + t.slice(1);
        if (!/[.!?]$/.test(t)) {
            t += ".";
        }
        return t;
    }

    function getCategoryLabel(key) {
        switch (key) {
            case "noun": return "ุงุณู (Noun)";
            case "verb": return "ูุนู (Verb)";
            case "adj":  return "ุตูุฉ (Adjective)";
            case "adv":  return "ุธุฑู (Adverb)";
            default:     return "";
        }
    }

    function getCategoryShortLabel(key) {
        switch (key) {
            case "noun": return "ุงุณู";
            case "verb": return "ูุนู";
            case "adj":  return "ุตูุฉ";
            case "adv":  return "ุธุฑู";
            default:     return "";
        }
    }

    function updateCount() {
        if (!tbody || !count) return;
        count.textContent = allRows.length;
    }

    // ุชูุนูู/ุฅูุบุงุก ูุถุน ุงูู Scroll ุจุญุณุจ ุนุฏุฏ ุงููููุงุช
    function updateTableScrollMode() {
        if (!dictTableWrapper) return;

        if (allRows.length > 15) {
            dictTableWrapper.classList.add("dict-scroll");
        } else {
            dictTableWrapper.classList.remove("dict-scroll");
        }
    }
function timeAgo(dateStr) {
    if (!dateStr) return "-";

    const d = new Date(dateStr);
    const now = new Date();
    const diff = (now - d) / 1000; // ุฌุฒุก ุจุงูุซูุงูู

    if (diff < 60) return "ููุฐ ูุญุธุงุช";
    if (diff < 3600) return `ูุจู ${Math.floor(diff / 60)} ุฏูููุฉ`;
    if (diff < 86400) return `ูุจู ${Math.floor(diff / 3600)} ุณุงุนุฉ`;
    if (diff < 604800) return `ูุจู ${Math.floor(diff / 86400)} ููู`;

    return d.toLocaleDateString("ar");
}

    // ุญุณุงุจ ุงูุฅุญุตุงุกุงุช ูุชุญุฏูุซ ุงูุจุทุงูุฉ
    function updateStatsCard() {
        // ุฅุฐุง ูู ุชูุฌุฏ ุนูุงุตุฑ ุงูุฅุญุตุงุกุงุช (ูุฃู ุณุจุจ) ูุฎุฑุฌ ุจูุฏูุก
        const totalEl = document.getElementById("stat-total");
        if (!totalEl) return;

        const nounEl       = document.getElementById("stat-noun");
        const verbEl       = document.getElementById("stat-verb");
        const adjEl        = document.getElementById("stat-adj");
        const advEl        = document.getElementById("stat-adv");
        const nounPercEl   = document.getElementById("stat-noun-perc");
        const verbPercEl   = document.getElementById("stat-verb-perc");
        const adjPercEl    = document.getElementById("stat-adj-perc");
        const advPercEl    = document.getElementById("stat-adv-perc");
        const latestEl = document.getElementById("stat-latest");

        let total = allRows.length;
        let noun = 0, verb = 0, adj = 0, adv = 0;

        allRows.forEach(row => {
            switch (row.dataset.cat) {
                case "noun": noun++; break;
                case "verb": verb++; break;
                case "adj":  adj++;  break;
                case "adv":  adv++;  break;
            }
        });

        // ุฃุฑูุงู
        totalEl.textContent = total;
        nounEl.textContent  = noun;
        verbEl.textContent  = verb;
        adjEl.textContent   = adj;
        advEl.textContent   = adv;

        // ูุณุจ ูุฆููุฉ
        const getPerc = (count) =>
            total === 0 ? "0%" : Math.round((count / total) * 100) + "%";

        nounPercEl.textContent = getPerc(noun);
        verbPercEl.textContent = getPerc(verb);
        adjPercEl.textContent  = getPerc(adj);
        advPercEl.textContent  = getPerc(adv);
    // ุฃุญุฏุซ ูููุฉ ูุถุงูุฉ
    if (latestEl) {
        if (allRows.length === 0) {
            latestEl.textContent = "ูุง ุชูุฌุฏ ูููุงุช ุจุนุฏ";
        } else {
            const sorted = [...allRows].sort((a, b) =>
                (b.dataset.createdAt || "").localeCompare(a.dataset.createdAt || "")
            );

            const last = sorted[0];
            const ar = last.dataset.ar || "-";
            const en = last.dataset.en || "-";
            const t  = timeAgo(last.dataset.createdAt);

            latestEl.innerHTML = `${en} โ ${ar}<br><span style="font-size:0.8rem;color:#9ca3af">${t}</span>`;
        }
    }
}

    function rebuildRowsCache() {
        if (!tbody) return;
        allRows = Array.from(tbody.querySelectorAll("tr"));
        updateCount();
        updateStatsCard();
        updateTableScrollMode(); // ุชุญุฏูุซ ูุถุน ุงูู Scroll ูููุง ุชุบูุฑุช ุงูุตููู
    }


    function applyFiltersAndPagination(resetPage) {
        if (!tbody) return;

        const searchValue = searchInput ? (searchInput.value || "").trim().toLowerCase() : "";
        const catValue    = categoryFilter ? (categoryFilter.value || "") : "";

        const filtered = allRows.filter(row => {
            const ar  = (row.dataset.ar  || "").toLowerCase();
            const en  = (row.dataset.en  || "").toLowerCase();
            const cat = (row.dataset.cat || "");

            let matchSearch = true;
            if (searchValue) {
                matchSearch = ar.includes(searchValue) || en.includes(searchValue);
            }

            let matchCat = true;
            if (catValue) {
                matchCat = cat === catValue;
            }

            return matchSearch && matchCat;
        });

        const total = filtered.length;
        totalPages  = Math.max(1, Math.ceil(total / PAGE_SIZE));

        if (resetPage || currentPage > totalPages) {
            currentPage = 1;
        }

        allRows.forEach(row => row.style.display = "none");

        const start = (currentPage - 1) * PAGE_SIZE;
        const end   = start + PAGE_SIZE;
        filtered.slice(start, end).forEach(row => row.style.display = "");

        renderPagination();
    }

    function renderPagination() {
        if (!paginationContainer) return;
        if (totalPages <= 1) {
            paginationContainer.innerHTML = "";
            return;
        }

        let html = "";
        html += `<button class="page-btn" data-page="prev" ${currentPage === 1 ? "disabled" : ""}>โน</button>`;

        for (let p = 1; p <= totalPages; p++) {
            html += `<button class="page-btn${p === currentPage ? " is-active" : ""}" data-page="${p}">${p}</button>`;
        }

        html += `<button class="page-btn" data-page="next" ${currentPage === totalPages ? "disabled" : ""}>โบ</button>`;

        paginationContainer.innerHTML = html;
    }

    function createRowFromData(item) {
        const tr = document.createElement("tr");
        tr.dataset.ar    = item.ar || "";
        tr.dataset.en    = item.en || "";
        tr.dataset.cat   = item.category || "";
        tr.dataset.senEn = item.sentence_en || "";
        tr.dataset.senAr = item.sentence_ar || "";
        tr.dataset.createdAt = item.createdAt || new Date().toISOString();

        tr.innerHTML = `
            <td>${item.ar || ""}</td>
            <td dir="ltr">${item.en || ""}</td>
            <td>${getCategoryShortLabel(item.category || "")}</td>
            <td dir="ltr" class="example-preview">${item.sentence_en || "-"}</td>
            <td>
                <button type="button" class="btn-table-action view-word">ุงูุชูุงุตูู</button>
            </td>
        `;
        return tr;
    }

    function serializeRows() {
        return allRows.map(row => {
    return {
        ar:          row.dataset.ar || "",
        en:          row.dataset.en || "",
        category:    row.dataset.cat || "",
        sentence_en: row.dataset.senEn || "",
        sentence_ar: row.dataset.senAr || "",
        createdAt:   row.dataset.createdAt || new Date().toISOString()
    };
});

    }

    function getCurrentDictKey() {
        if (!currentStudent) return null;
        return DICT_KEY_PREFIX + currentStudent.id;
    }

    function formatUpdateString() {
        try {
            // ุชูุณูู ุจุณูุท: ุชุงุฑูุฎ + ููุช ูุตูุฑ ุจุงูุนุฑุจู
            return new Date().toLocaleString("ar", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        } catch (e) {
            // ูู ุญุงู ุงููุชุตูุญ ูุง ูุฏุนู ุงูุฎูุงุฑุงุช
            return new Date().toLocaleString("ar");
        }
    }

    function touchStudentLastUpdate() {
        // ูุง ูููู ุงูุชุญุฏูุซ ุจุฏูู ุทุงูุจ ุญุงูู
        if (!currentStudent) return;

        try {
            const raw = localStorage.getItem(STORAGE_KEY_STUDENTS);
            if (!raw) return;

            const list = JSON.parse(raw) || [];
            const idx = list.findIndex(s => s.id === currentStudent.id);
            if (idx === -1) return;

            // ุชุญุฏูุซ ุญูู lastUpdate ููุทุงูุจ
            list[idx].lastUpdate = formatUpdateString();

            localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(list));
        } catch (err) {
            console.error("Error updating student lastUpdate:", err);
        }
    }

    function saveDictionaryToStorage() {
        const key = getCurrentDictKey();
        if (!key) return;
        try {
            const data = serializeRows();
            localStorage.setItem(key, JSON.stringify(data));

            // ูู ุนูููุฉ ุญูุธ ูููุงููุณ ุชุนุชุจุฑ "ุขุฎุฑ ุชุญุฏูุซ"
            touchStudentLastUpdate();
        } catch (err) {
            console.error("Error saving dictionary:", err);
        }
    }


function loadDictionaryForCurrentStudent() {
    if (!tbody) return;
    tbody.innerHTML = "";
    allRows = [];
    updateCount();

    if (!currentStudent) {
        // ุฅูุบุงุก ุฃู ูุฑุฒ
        currentSortKey = null;
        currentSortDir = null;

        applyFiltersAndPagination(true);
        return;
    }

    const key = getCurrentDictKey();
    let data = [];

    try {
        const raw = localStorage.getItem(key);
        if (!raw) {
            // ุฃูู ูุฑุฉ ููุฐุง ุงูุทุงูุจ: ุฃูุซูุฉ ุจุณูุทุฉ
            data = [
                {
                    ar: "ูุฏุฑุณุฉ",
                    en: "School",
                    category: "noun",
                    sentence_en: "I go to school every day.",
                    sentence_ar: "ุฃุฐูุจ ุฅูู ุงููุฏุฑุณุฉ ูู ููู."
                },
                {
                    ar: "ุทุงูุจ",
                    en: "Student",
                    category: "noun",
                    sentence_en: "The student is smart.",
                    sentence_ar: "ุงูุทุงูุจ ุฐูู."
                }
            ];
        } else {
            data = JSON.parse(raw) || [];
	   data = data.map(item => ({
    ...item,
    createdAt: item.createdAt || new Date().toISOString()
}));

data.forEach(item => {
    const tr = createRowFromData(item);
    tbody.appendChild(tr);
});


        }
    } catch (err) {
        console.error("Error loading dictionary:", err);
        data = [];
    }

    rebuildRowsCache();
    applyFiltersAndPagination(true);

    // --------------------------
    // 1) ุฅูุบุงุก ุฃู ูุฑุฒ ุณุงุจู
    // --------------------------
    currentSortKey = null;
    currentSortDir = null;

    // --------------------------
    // 2) ุฅุฒุงูุฉ ุฃู order ููุชุณุจ ูู ุงููุฑุฒ ุงูุณุงุจู
    // --------------------------
    tbody.querySelectorAll("tr").forEach(row => {
        row.style.order = "";
    });

    // --------------------------
    // 3) ุฅุฒุงูุฉ ุชูููุฒ ุงูุฑุคูุณ ูุงูุณูู
    // --------------------------
    document.querySelectorAll(".sortable").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
        th.removeAttribute("data-sort");
    });
}


    // ===== Toast Notifications =====
    function showToast(message, type) {
        if (!toastContainer) return;
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.style.minWidth = "220px";
        toast.style.maxWidth = "360px";
        toast.style.padding = "0.6rem 0.9rem";
        toast.style.borderRadius = "0.75rem";
        toast.style.fontSize = "0.85rem";
        toast.style.boxShadow = "0 10px 25px rgba(0,0,0,0.45)";
        toast.style.display = "flex";
        toast.style.alignItems = "center";
        toast.style.justifyContent = "space-between";
        toast.style.gap = "0.75rem";
        toast.style.color = "#f9fafb";
        toast.style.direction = "rtl";
        toast.style.pointerEvents = "auto";
        toast.style.opacity = "0";
        toast.style.transform = "translateY(10px)";
        toast.style.transition = "opacity 0.2s ease, transform 0.2s ease";

        let bg = "#374151";
        if (type === "success") bg = "#166534";
        else if (type === "error") bg = "#7f1d1d";
        else if (type === "info") bg = "#1f2937";
        toast.style.background = bg;

        const closeBtn = document.createElement("button");
        closeBtn.textContent = "ร";
        closeBtn.style.border = "none";
        closeBtn.style.background = "transparent";
        closeBtn.style.color = "#9ca3af";
        closeBtn.style.cursor = "pointer";
        closeBtn.style.fontSize = "1rem";
        closeBtn.style.padding = "0";
        closeBtn.style.margin = "0";
        closeBtn.addEventListener("click", () => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(10px)";
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 200);
        });

        toast.appendChild(closeBtn);
        toastContainer.appendChild(toast);

        // animate in
        requestAnimationFrame(() => {
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
        });

        // auto hide
        setTimeout(() => {
            if (!toast.isConnected) return;
            toast.style.opacity = "0";
            toast.style.transform = "translateY(10px)";
            setTimeout(() => {
                if (toast.isConnected) toastContainer.removeChild(toast);
            }, 200);
        }, 2800);
    }

    // ===== Confirm Modal =====
    function openConfirm(message, onConfirm) {
        if (!confirmBackdrop || !confirmMessageEl) return;
        confirmMessageEl.textContent = message;
        confirmHandler = typeof onConfirm === "function" ? onConfirm : null;
        confirmBackdrop.style.display = "flex";
        confirmBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeConfirm() {
        if (!confirmBackdrop) return;
        confirmBackdrop.style.display = "none";
        confirmBackdrop.setAttribute("aria-hidden", "true");
        confirmHandler = null;
    }

    if (confirmYesBtn) {
        confirmYesBtn.addEventListener("click", function () {
            if (confirmHandler) {
                const fn = confirmHandler;
                confirmHandler = null;
                fn();
            }
            closeConfirm();
        });
    }

    if (confirmNoBtn) {
        confirmNoBtn.addEventListener("click", function () {
            closeConfirm();
        });
    }

    if (confirmBackdrop) {
        confirmBackdrop.addEventListener("click", function (e) {
            if (e.target === confirmBackdrop) {
                closeConfirm();
            }
        });
    }
const urlParams = new URLSearchParams(window.location.search);
const preselectedId = urlParams.get("studentId");
    function setCurrentStudentById(id) {
        const s = students.find(st => st.id === id);
        currentStudent = s || null;

        if (!currentStudent) {
            if (studentNameLine) studentNameLine.textContent  = "ูู ูุชู ุงุฎุชูุงุฑ ุทุงูุจ ุจุนุฏ";
            if (studentGradeLine) studentGradeLine.textContent = "ุงุฎุชุฑ ุงูุทุงูุจ ูู ุงููุงุฆูุฉ ุฃุนูู ุงูุตูุญุฉ.";
            if (studentAvatarWrap) studentAvatarWrap.style.display = "none";
            if (dictFormHint) dictFormHint.textContent = "ุงุฎุชุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุฅุถุงูุฉ ุงููููุงุช.";
            loadDictionaryForCurrentStudent();
            return;
        }

        if (studentNameLine) {
            studentNameLine.textContent = currentStudent.name + " โ " + currentStudent.grade;
        }
        if (studentGradeLine) {
            studentGradeLine.textContent = "ุงููุงููุณ ุงูุฎุงุต ุจุงูุทุงูุจ.";
        }

        if (currentStudent.avatar) {
            if (studentAvatarImg) studentAvatarImg.src = currentStudent.avatar;
            if (studentAvatarWrap) studentAvatarWrap.style.display = "block";
        } else {
            if (studentAvatarWrap) studentAvatarWrap.style.display = "none";
        }

        if (dictFormHint) {
            dictFormHint.textContent = "ุงููููุงุช ุงูุชู ูุชู ุญูุธูุง ุงูุขู ุชุฎุต ุงูุทุงูุจ: " +
                currentStudent.name + " (" + currentStudent.grade + ").";
        }

        loadDictionaryForCurrentStudent();
    }
    // ===== ุชุญููู ุงูุทูุงุจ ูููุชุฑ ุงูุทุงูุจ =====
    function loadStudents() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY_STUDENTS);
            if (!raw) {
                students = [];
            } else {
                const parsed = JSON.parse(raw) || [];
                students = parsed.map(s => ({
                id:     s.id,
                name:   s.name,
                grade:  s.grade,
                avatar: s.avatar || null
            })).filter(s => s.id && s.name);

            }
        } catch (e) {
            console.error("Error loading students list:", e);
            students = [];
        }

        if (studentSelect) {
            studentSelect.innerHTML = `<option value="">ุงุฎุชุฑ ุงูุทุงูุจ...</option>`;
            students.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.id;
                opt.textContent = `${s.name} โ ${s.grade}`;
                studentSelect.appendChild(opt);
            });
}

if (students.length === 0) {
    if (studentNameLine) {
        studentNameLine.textContent = "ูุง ููุฌุฏ ุทูุงุจ ูุณุฌูููู ุจุนุฏ";
    }
    if (studentGradeLine) {
        studentGradeLine.textContent = "ุงุฐูุจ ุฅูู ุตูุญุฉ (ุงูุทูุงุจ) ูุฅุถุงูุฉ ุทุงูุจ ุซู ุนุฏ ุฅูู ููุง.";
    }
    if (dictFormHint) {
        dictFormHint.textContent = "ูุง ูููู ุฅุถุงูุฉ ูููุงุช ูุจู ุฅุถุงูุฉ ุทุงูุจ ูู ุตูุญุฉ (ุงูุทูุงุจ).";
    }
} else {
}
    // ุงุฎุชูุงุฑ ุชููุงุฆู ุจูุงุกู ุนูู ุงูุฑุงุจุท
    if (preselectedId && students.some(s => s.id === preselectedId)) {
        studentSelect.value = preselectedId;
        setCurrentStudentById(preselectedId);
    } else {
        const first = students[0];
        studentSelect.value = first.id;
        setCurrentStudentById(first.id);
    }
}

    if (studentSelect) {
        studentSelect.addEventListener("change", function () {
            const id = studentSelect.value || "";
            setCurrentStudentById(id);
        });
    }

    // ===== ุฅุนุฏุงุฏุงุช ุงูุตูุช =====
    function loadAudioSettings() {
        try {
            const savedVoice = localStorage.getItem(STORAGE_KEY_VOICE);
            const savedRate  = localStorage.getItem(STORAGE_KEY_RATE);
            if (savedVoice) selectedVoiceName = savedVoice;
            if (savedRate) {
                const r = parseFloat(savedRate);
                if (!Number.isNaN(r) && r > 0.4 && r < 2) {
                    speechRate = r;
                }
            }
        } catch (err) {
            console.error("Error loading audio settings:", err);
        }
        if (rateValueSpan) {
            rateValueSpan.textContent = speechRate.toFixed(2);
        }
    }

    function saveAudioSettings() {
        try {
            localStorage.setItem(STORAGE_KEY_VOICE, selectedVoiceName || "");
            localStorage.setItem(STORAGE_KEY_RATE, String(speechRate));
        } catch (err) {
            console.error("Error saving audio settings:", err);
        }
    }

    function populateVoices() {
        if (!("speechSynthesis" in window) || !voiceSelect) return;
        voices = window.speechSynthesis.getVoices() || [];
        const englishVoices = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith("en"));

        voiceSelect.innerHTML = '<option value="">ุงุฎุชูุงุฑ ุชููุงุฆู (ุฃูุถู ุตูุช ุฅูุฌููุฒู)</option>';
        englishVoices.forEach(v => {
            const option = document.createElement("option");
            option.value = v.name;
            option.textContent = `${v.name} (${v.lang})`;
            voiceSelect.appendChild(option);
        });

        if (selectedVoiceName) {
            const found = englishVoices.find(v => v.name === selectedVoiceName);
            if (found) voiceSelect.value = selectedVoiceName;
        }
    }

    function initVoices() {
        if (!("speechSynthesis" in window)) return;
        populateVoices();
        window.speechSynthesis.onvoiceschanged = populateVoices;
    }

    function speak(text) {
        if (!("speechSynthesis" in window)) return;
        const t = (text || "").trim();
        if (!t) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(t);
        utterance.lang  = "en-US";
        utterance.rate  = speechRate;

        if (voices && voices.length) {
            const englishVoices = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith("en"));
            let chosen = null;
            if (selectedVoiceName) {
                chosen = englishVoices.find(v => v.name === selectedVoiceName);
            }
            if (!chosen) {
                chosen = englishVoices[0] || voices[0];
            }
            if (chosen) {
                utterance.voice = chosen;
                utterance.lang  = chosen.lang || "en-US";
            }
        }
        window.speechSynthesis.speak(utterance);
    }

    if (voiceSelect) {
        voiceSelect.addEventListener("change", function () {
            selectedVoiceName = voiceSelect.value || "";
            saveAudioSettings();
        });
    }

    function updateRateDisplay() {
        if (rateValueSpan) {
            rateValueSpan.textContent = speechRate.toFixed(2);
        }
    }

    if (rateDownBtn) {
        rateDownBtn.addEventListener("click", function () {
            speechRate = Math.max(0.6, speechRate - 0.05);
            updateRateDisplay();
            saveAudioSettings();
        });
    }

    if (rateUpBtn) {
        rateUpBtn.addEventListener("click", function () {
            speechRate = Math.min(1.4, speechRate + 0.05);
            updateRateDisplay();
            saveAudioSettings();
        });
    }

    // ===== ุงูููุฏุงู =====
    function openModalFromRow(row) {
        if (!row || !modalBackdrop || !wordModal) return;

        currentRow = row;
        const ar    = row.dataset.ar    || "";
        const en    = row.dataset.en    || "";
        const cat   = row.dataset.cat   || "";
        const senEn = row.dataset.senEn || "";
        const senAr = row.dataset.senAr || "";

        currentWordEn     = en;
        currentSentenceEn = senEn;

        wordModal.classList.remove("is-edit-mode");

        modalWordEn.textContent     = en;
        modalWordAr.textContent     = ar;
        modalWordCat.textContent    = getCategoryLabel(cat);
        modalSentenceEn.textContent = senEn;
        modalSentenceAr.textContent = senAr;
        modalWordCatInput.value     = cat || "noun";

        clearErrors([
            modalWordEnInput,
            modalWordArInput,
            modalSentenceEnInput,
            modalSentenceArInput
        ]);

        // ุนุฑุถ ุฃุฒุฑุงุฑ ุงูุนุฑุถ / ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุชุนุฏูู
        if (modalViewActions) modalViewActions.style.display = "flex";
        if (modalEditActions) modalEditActions.style.display = "none";

        modalBackdrop.classList.add("is-visible");
        document.body.classList.add("no-scroll");
        modalBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
        if (!modalBackdrop || !wordModal) return;
        modalBackdrop.classList.remove("is-visible");
        document.body.classList.remove("no-scroll");
        modalBackdrop.setAttribute("aria-hidden", "true");
        wordModal.classList.remove("is-edit-mode");
        currentRow = null;
    }

    if (tbody) {
        tbody.addEventListener("click", function (e) {
            const btn = e.target.closest(".view-word");
            if (!btn) return;
            const row = btn.closest("tr");
            openModalFromRow(row);
        });
    }

    if (modalCloseBtn) {
        modalCloseBtn.addEventListener("click", closeModal);
    }
    if (modalCloseBtn2) {
        modalCloseBtn2.addEventListener("click", closeModal);
    }

    if (modalBackdrop) {
        modalBackdrop.addEventListener("click", function (e) {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });
    }

    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            // ูู ููุฏุงู ุงูุชุฃููุฏ ููุชูุญุ ูุบูู ุฃููุงู
            if (confirmBackdrop && confirmBackdrop.style.display === "flex") {
                closeConfirm();
                return;
            }
            closeModal();
        }
    });

    if (speakWordBtn) {
        speakWordBtn.addEventListener("click", function () {
            const text = wordModal && wordModal.classList.contains("is-edit-mode")
                ? (modalWordEnInput.value || currentWordEn)
                : currentWordEn;
            speak(text);
        });
    }

    if (speakSentenceBtn) {
        speakSentenceBtn.addEventListener("click", function () {
            const text = wordModal && wordModal.classList.contains("is-edit-mode")
                ? (modalSentenceEnInput.value || currentSentenceEn)
                : currentSentenceEn;
            speak(text);
        });
    }

    if (modalEditBtn && wordModal) {
        modalEditBtn.addEventListener("click", function () {
            if (!currentRow) return;

            modalWordEnInput.value      = modalWordEn.textContent.trim();
            modalWordArInput.value      = modalWordAr.textContent.trim();
            modalSentenceEnInput.value  = modalSentenceEn.textContent.trim();
            modalSentenceArInput.value  = modalSentenceAr.textContent.trim();
            modalWordCatInput.value     = currentRow.dataset.cat || "noun";

            clearErrors([
                modalWordEnInput,
                modalWordArInput,
                modalSentenceEnInput,
                modalSentenceArInput
            ]);

            wordModal.classList.add("is-edit-mode");
            if (modalViewActions) modalViewActions.style.display = "none";
            if (modalEditActions) modalEditActions.style.display = "flex";
        });
    }

    if (modalCancelBtn && wordModal) {
        modalCancelBtn.addEventListener("click", function () {
            // ุฅูุบุงุก ุงูุชุนุฏูู ููุท ูุงูุนูุฏุฉ ููุถุน ุงูุนุฑุถ
            wordModal.classList.remove("is-edit-mode");
            clearErrors([
                modalWordEnInput,
                modalWordArInput,
                modalSentenceEnInput,
                modalSentenceArInput
            ]);
            if (modalViewActions) modalViewActions.style.display = "flex";
            if (modalEditActions) modalEditActions.style.display = "none";
        });
    }

    if (modalSaveBtn && wordModal) {
        modalSaveBtn.addEventListener("click", function () {
            if (!currentRow) return;

            const okEn    = validateEnglish(modalWordEnInput, { required: true });
            const okAr    = validateArabic(modalWordArInput, { required: true });
            const okSenEn = validateEnglish(modalSentenceEnInput, { required: false });
            const okSenAr = validateArabic(modalSentenceArInput, { required: false });

            if (!okEn || !okAr || !okSenEn || !okSenAr) return;

            const newAr   = modalWordArInput.value.trim();
            let newEn     = modalWordEnInput.value.trim();
            let newSenEn  = modalSentenceEnInput.value.trim();
            const newSenAr= modalSentenceArInput.value.trim();
            const newCat  = modalWordCatInput.value || "noun";

            newEn = normalizeEnglishWord(newEn);
            if (newSenEn) {
                newSenEn = normalizeEnglishSentence(newSenEn);
            }

            currentRow.dataset.ar    = newAr;
            currentRow.dataset.en    = newEn;
            currentRow.dataset.cat   = newCat;
            currentRow.dataset.senEn = newSenEn;
            currentRow.dataset.senAr = newSenAr;

            if (currentRow.cells[0]) currentRow.cells[0].textContent = newAr;
            if (currentRow.cells[1]) currentRow.cells[1].textContent = newEn;
            if (currentRow.cells[2]) currentRow.cells[2].textContent = getCategoryShortLabel(newCat);
            if (currentRow.cells[3]) currentRow.cells[3].textContent = newSenEn || "-";

            modalWordEn.textContent     = newEn;
            modalWordAr.textContent     = newAr;
            modalWordCat.textContent    = getCategoryLabel(newCat);
            modalSentenceEn.textContent = newSenEn;
            modalSentenceAr.textContent = newSenAr;

            currentWordEn     = newEn;
            currentSentenceEn = newSenEn;

            wordModal.classList.remove("is-edit-mode");
            if (modalViewActions) modalViewActions.style.display = "flex";
            if (modalEditActions) modalEditActions.style.display = "none";

            rebuildRowsCache();
            applyFiltersAndPagination(false);
            saveDictionaryToStorage();
            closeModal();
            showToast("ุชู ุญูุธ ุงูุชุนุฏูู ุจูุฌุงุญ.", "success");
        });
    }

    // ุญุฐู ูููุฉ ูุงุญุฏุฉ ูู ุฏุงุฎู ุงูููุฏุงู
    if (modalDeleteBtn) {
        modalDeleteBtn.addEventListener("click", function () {
            if (!currentRow) return;
            openConfirm(
                "ุณูุชู ุญุฐู ูุฐู ุงููููุฉ ูู ูุงููุณ ุงูุทุงูุจ. ูู ุชุฑุบุจ ุจุงููุชุงุจุนุฉุ",
                function () {
                    if (!currentRow) return;
                    const rowToRemove = currentRow;
                    currentRow = null;
                    rowToRemove.remove();
                    rebuildRowsCache();
                    applyFiltersAndPagination(true);
                    saveDictionaryToStorage();
                    closeModal();
                    showToast("ุชู ุญุฐู ุงููููุฉ ุจูุฌุงุญ.", "success");
                }
            );
        });
    }

    // ุชุญูู ุฃุซูุงุก ุงููุชุงุจุฉ ูู ุงูููุฏุงู
    if (modalWordEnInput) modalWordEnInput.addEventListener("input", () => validateEnglish(modalWordEnInput, { required: true }));
    if (modalWordArInput) modalWordArInput.addEventListener("input", () => validateArabic(modalWordArInput, { required: true }));
    if (modalSentenceEnInput) modalSentenceEnInput.addEventListener("input", () => validateEnglish(modalSentenceEnInput, { required: false }));
    if (modalSentenceArInput) modalSentenceArInput.addEventListener("input", () => validateArabic(modalSentenceArInput, { required: false }));

    // ุชุญูู ุฃุซูุงุก ุงููุชุงุจุฉ ูู ุงููููุฐุฌ ุงูุฃุณุงุณู
    if (enInput) enInput.addEventListener("input", () => validateEnglish(enInput, { required: true }));
    if (arInput) arInput.addEventListener("input", () => validateArabic(arInput, { required: true }));
    if (exEnInput) exEnInput.addEventListener("input", () => validateEnglish(exEnInput, { required: false }));
    if (exArInput) exArInput.addEventListener("input", () => validateArabic(exArInput, { required: false }));

    // ุฅุถุงูุฉ ูููุฉ ุฌุฏูุฏุฉ
    if (form && tbody) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            if (!currentStudent) {
                showToast("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุฅุถุงูุฉ ุงููููุงุช.", "error");
                return;
            }

            const okEn    = validateEnglish(enInput, { required: true });
            const okAr    = validateArabic(arInput, { required: true });
            const okSenEn = validateEnglish(exEnInput, { required: false });
            const okSenAr = validateArabic(exArInput, { required: false });

            if (!okEn || !okAr || !okSenEn || !okSenAr) return;

            const arRaw   = (arInput.value || "").trim();
            let enRaw     = (enInput.value || "").trim();
            let senEnRaw  = (exEnInput.value || "").trim();
            const senArRaw= (exArInput.value || "").trim();
            const cat     = catSelect.value;

            if (!arRaw || !enRaw || !cat) return;

            const ar      = arRaw;
            let   en      = normalizeEnglishWord(enRaw);
            let   senEn   = senEnRaw ? normalizeEnglishSentence(senEnRaw) : "";

            const tr = createRowFromData({
   	    ar,
            en,
            category:    cat,
            sentence_en: senEn,
            sentence_ar: senArRaw,
            createdAt:   new Date().toISOString()   // << ุฅุถุงูุฉ ุงูุชุงุฑูุฎ ููุง
            });


            tbody.appendChild(tr);

            form.reset();
            clearErrors([arInput, enInput, exEnInput, exArInput]);

            rebuildRowsCache();
            currentPage = Math.ceil(allRows.length / PAGE_SIZE);
            applyFiltersAndPagination(false);
            saveDictionaryToStorage();
            showToast("ุชู ุญูุธ ุงููููุฉ ุจูุฌุงุญ.", "success");
        });
    }

    // ุงูุจุญุซ ูุงูุชุตููู
    if (searchInput) {
        searchInput.addEventListener("input", () => applyFiltersAndPagination(true));
    }
    if (categoryFilter) {
        categoryFilter.addEventListener("change", () => applyFiltersAndPagination(true));
    }

    // ุงูุชุฑููู
    if (paginationContainer) {
        paginationContainer.addEventListener("click", function (e) {
            const btn = e.target.closest(".page-btn");
            if (!btn || btn.disabled) return;

            const page = btn.dataset.page;
            if (page === "prev") {
                if (currentPage > 1) currentPage--;
            } else if (page === "next") {
                if (currentPage < totalPages) currentPage++;
            } else {
                const num = parseInt(page, 10);
                if (!Number.isNaN(num)) currentPage = num;
            }
            applyFiltersAndPagination(false);
        });
    }

    // ุชูุฒูู ููู ูุตู
    function downloadTextFile(filename, text, mime) {
        const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement("a");
        a.href     = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ุชุตุฏูุฑ JSON
    if (exportJsonBtn) {
        exportJsonBtn.addEventListener("click", function () {
            if (!currentStudent) {
                showToast("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุงูุชุตุฏูุฑ.", "error");
                return;
            }
            const data = serializeRows();
            const json = JSON.stringify(data, null, 2);
            const filename = "dictionary_" + currentStudent.name + ".json";
            downloadTextFile(filename, json, "application/json;charset=utf-8");
            showToast("ุชู ุชุตุฏูุฑ ุงููุงููุณ ุจุตูุบุฉ JSON.", "success");
        });
    }

    // ุชุตุฏูุฑ XML
    if (exportXmlBtn) {
        exportXmlBtn.addEventListener("click", function () {
            if (!currentStudent) {
                showToast("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุงูุชุตุฏูุฑ.", "error");
                return;
            }
            const data = serializeRows();
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<dictionary>\n';
            data.forEach(item => {
                xml += "  <word>\n";
                xml += "    <ar>" + (item.ar || "") + "</ar>\n";
                xml += "    <en>" + (item.en || "") + "</en>\n";
                xml += "    <category>" + (item.category || "") + "</category>\n";
                xml += "    <sentence_en>" + (item.sentence_en || "") + "</sentence_en>\n";
                xml += "    <sentence_ar>" + (item.sentence_ar || "") + "</sentence_ar>\n";
		xml += "    <createdAt>" + (item.createdAt || "") + "</createdAt>\n";
                xml += "  </word>\n";
            });
            xml += "</dictionary>\n";
            const filename = "dictionary_" + currentStudent.name + ".xml";
            downloadTextFile(filename, xml, "application/xml;charset=utf-8");
            showToast("ุชู ุชุตุฏูุฑ ุงููุงููุณ ุจุตูุบุฉ XML.", "success");
        });
    }

    // ุญุฐู ุฌููุน ุงููููุงุช ููุทุงูุจ ุงูุญุงูู
    if (clearAllBtn) {
        clearAllBtn.addEventListener("click", function () {
            if (!currentStudent) {
                showToast("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุงูุญุฐู.", "error");
                return;
            }
            if (!allRows.length) {
                showToast("ูุง ุชูุฌุฏ ูููุงุช ูุญุฐููุง ููุฐุง ุงูุทุงูุจ.", "info");
                return;
            }

            openConfirm(
                "ุณูุชู ุญุฐู ุฌููุน ุงููููุงุช ูู ูุงููุณ ูุฐุง ุงูุทุงูุจ. ูู ุชุฑุบุจ ุจุงููุชุงุจุนุฉุ",
                function () {
                    if (!tbody) return;
                    tbody.innerHTML = "";
                    allRows = [];
                    updateCount();
                    applyFiltersAndPagination(true);
                    saveDictionaryToStorage();
                    showToast("ุชู ุญุฐู ุฌููุน ูููุงุช ุงูุทุงูุจ ุจูุฌุงุญ.", "success");
                }
            );
        });
    }

    // ุงุณุชูุฑุงุฏ JSON / XML
    if (importFileInput) {
        importFileInput.addEventListener("change", function () {
            const file = importFileInput.files[0];
            importFileInput.value = "";
            if (!file) return;

            if (!currentStudent) {
                showToast("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุทุงูุจ ุฃููุงู ูุจู ุงูุงุณุชูุฑุงุฏ.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                handleImportContent(file.name, content);
            };
            reader.readAsText(file, "utf-8");
        });
    }

    function handleImportContent(filename, content) {
        let imported = [];
        try {
            if (filename.toLowerCase().endsWith(".json")) {
                const data = JSON.parse(content);
                if (Array.isArray(data)) imported = data;
            } else if (filename.toLowerCase().endsWith(".xml")) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(content, "application/xml");
                const wordNodes = xmlDoc.getElementsByTagName("word");
                imported = Array.from(wordNodes).map(node => {
                    const getText = tag => {
                        const el = node.getElementsByTagName(tag)[0];
                        return el ? (el.textContent || "") : "";
                    };
                    return {
                        ar:          getText("ar"),
                        en:          getText("en"),
                        category:    getText("category"),
                        sentence_en: getText("sentence_en"),
                        sentence_ar: getText("sentence_ar"),
			createdAt:   getText("createdAt") || new Date().toISOString()
                    };
                });
            }
        } catch (err) {
            console.error("Import error:", err);
        }

        if (!Array.isArray(imported) || !imported.length) {
            if (importResult) {
                importResult.textContent = "ูู ูุชู ุงูุชุนุฑู ุนูู ุจูุงูุงุช ุตุงูุญุฉ ูู ุงูููู.";
            }
            showToast("ูุดู ุงูุงุณุชูุฑุงุฏ: ููู ุบูุฑ ุตุงูุญ.", "error");
            return;
        }

        const existing = new Set(
            allRows.map(r => (r.dataset.en || "").trim().toLowerCase()).filter(Boolean)
        );

        let addedCount   = 0;
        let skippedCount = 0;

        imported.forEach(item => {
            const enRaw = (item.en || "").trim();
            if (!enRaw) {
                skippedCount++;
                return;
            }

            const enNormalized = normalizeEnglishWord(enRaw);
            const enKey        = enNormalized.toLowerCase();

            if (existing.has(enKey)) {
                skippedCount++;
                return;
            }

            const ar   = (item.ar || "").trim();
            const cat  = (item.category || "").trim() || "noun";
            let senEn  = (item.sentence_en || "").trim();
            const senAr= (item.sentence_ar || "").trim();

            if (senEn) {
                senEn = normalizeEnglishSentence(senEn);
            }

            const tr = createRowFromData({
                ar,
                en: enNormalized,
                category: cat,
                sentence_en: senEn,
                sentence_ar: senAr,
		createdAt: item.createdAt || new Date().toISOString()
            });

            tbody.appendChild(tr);
            existing.add(enKey);
            addedCount++;
        });

        rebuildRowsCache();
        applyFiltersAndPagination(true);
        saveDictionaryToStorage();

        if (importResult) {
            importResult.textContent =
                "ุชู ุฅุถุงูุฉ " + addedCount + " ูููุฉ ุฌุฏูุฏุฉ โ ูุชู ุชุฌุงูู " +
                skippedCount + " ูููุฉ ููุฌูุฏุฉ ูุณุจููุง.";
        }
        showToast("ุชู ุงุณุชูุฑุงุฏ ุงููููุงุช ุจูุฌุงุญ.", "success");
    }
/* ========== SORTING ========== */

let currentSortKey = null;
let currentSortDir = "asc"; // asc | desc

function sortRows(key) {
    if (!allRows.length) return;

    // ุฅุฐุง ุถุบุท ููุณ ุงูุนููุฏ โ ูุนูุณ ุงูุงุชุฌุงู
    if (currentSortKey === key) {
        currentSortDir = currentSortDir === "asc" ? "desc" : "asc";
    } else {
        currentSortKey = key;
        currentSortDir = "asc";
    }

    // ุฅุฒุงูุฉ ุชูููุฒ ุงููุฑุฒ ูู ุฌููุน ุงูุฃุนูุฏุฉ
    document.querySelectorAll("th.sortable").forEach(th => {
        th.classList.remove("asc", "desc", "sort-active");
    });

    // ุฅุถุงูุฉ ุงูุชูููุฒ ููุนููุฏ ุงููุญุฏุฏ
    const activeTh = document.querySelector(`th.sortable[data-key='${key}']`);
    if (activeTh) {
        activeTh.classList.add("sort-active");
        activeTh.classList.add(currentSortDir);
    }

    // ูุฑุฒ ุงูุตููู
    allRows.sort((a, b) => {
        const A = (a.dataset[key] || "").toLowerCase();
        const B = (b.dataset[key] || "").toLowerCase();

        if (A < B) return currentSortDir === "asc" ? -1 : 1;
        if (A > B) return currentSortDir === "asc" ? 1 : -1;
        return 0;
    });

    // ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุงูุตููู ุจุงูุชุฑุชูุจ ุงูุฌุฏูุฏ
    allRows.forEach(r => tbody.appendChild(r));

    applyFiltersAndPagination(true);
}

/* ุชูุนูู ุงููุฑุฒ ุนูุฏ ุงูุถุบุท ุนูู ุฑุฃุณ ุงูุนููุฏ */
document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", function () {
        sortRows(this.dataset.key);
    });
});
// ================= ุฅุนุงุฏุฉ ุงูุชุฑุชูุจ ุงูุงูุชุฑุงุถู =================
const resetSortBtn = document.getElementById("reset-sort-btn");
if (resetSortBtn) {
    resetSortBtn.addEventListener("click", function () {

        // 1) ุฅุฒุงูุฉ ุงูุณูู + ุงูููุงุณุงุช ูู ูู ุงูุฃุนูุฏุฉ
        document.querySelectorAll("th.sortable").forEach(th => {
            th.classList.remove("sort-asc", "sort-desc", "sorted-column");
            th.removeAttribute("data-sort-dir");

            // ุงูุญู ุงููุนูู 100%
            th.innerHTML = th.textContent.trim();
        });

        // 2) ุงุณุชุนุงุฏุฉ ุงูุชุฑุชูุจ ุงูุฃุณุงุณู ุญุณุจ ุชุงุฑูุฎ ุงูุฅุถุงูุฉ
        allRows.sort((a, b) => {
            const da = a.dataset.createdAt || "";
            const db = b.dataset.createdAt || "";
            return da.localeCompare(db);
        });

        // 3) ุฅุนุงุฏุฉ ุจูุงุก ุงูุฌุณู
        tbody.innerHTML = "";
        allRows.forEach(r => tbody.appendChild(r));

        // 4) ุชุญุฏูุซ ุงูููุงุชุฑ ูุงูุตูุญุงุช
        applyFiltersAndPagination(true);

        // 5) ุฅููุงู ุฃู ูุฑุฒ ูุนูุงู
        currentSortKey = null;
        currentSortDir = null;
    });
}

    // ===== ุชููุฆุฉ ุฃูููุฉ =====
    loadAudioSettings();
    initVoices();
    loadStudents();
});
</script>
</body>
</html>
